name: Deploy the tjikko-studio/components library
on:
  release:
    types: [ published ]
jobs:
  test:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2

      - name: 'Setup NPM'
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org'

      - name: 'Setup npmrc'
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc

      - name: 'Install'
        run: npm ci

      - name: 'Build'
        run: npm run build

      - name: 'Build Storybook'
        run: npm run build:storybook

      - name: 'Run tests'
        run: npm test

      - name: 'Keep static storybook'
        uses: actions/upload-artifact@master
        with:
          name: storybook-static
          path: storybook-static

  npm-publish:
    needs: test
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2

      - name: 'Setup NPM'
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org'

      - name: 'Setup npmrc'
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc

      - name: 'Install'
        run: npm ci

      - name: 'Build'
        run: npm run build

      - name: 'Publish to npm'
        run: npm publish

  deploy-to-ftp:
    needs: npm-publish
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2

      - name: 'Retrieve static storybook'
        uses: actions/download-artifact@master
        with:
          name: storybook-static
          path: storybook-static

      - name: 'Upload to the server'
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }}
          user: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          localDir: 'storybook-static'
          remoteDir: '.'
          options: "--delete --transfer-all"

#  deploy-to-gh-pages:
#    needs: npm-publish
#    runs-on: ubuntu-latest
#    env:
#      CI: true
#    steps:
#      - name: 'Checkout'
#        uses: actions/checkout@v2
#
#      - name: 'Setup NPM'
#        uses: actions/setup-node@v2
#        with:
#          node-version: '14.x'
#          registry-url: 'https://registry.npmjs.org'
#
#      - name: 'Setup npmrc'
#        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
#
#      - name: 'Install'
#        run: npm ci
#
#      - name: 'Build'
#        run: npm run build:all
#
#      - name: Deploy ðŸš€
#        uses: JamesIves/github-pages-deploy-action@4.1.4
#        with:
#          branch: demo
#          folder: storybook-static
